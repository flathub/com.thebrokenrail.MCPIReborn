app-id: com.thebrokenrail.MCPIReborn

# No Separate Locales
separate-locales: false

# MCPI Itself Is Proprietary
tags:
  - proprietary

# Runtime/SDK
runtime: org.freedesktop.Platform
# Newer Runtimes Don't Support ARM Multiarch
runtime-version: '19.08'
sdk: org.freedesktop.Sdk

# Startup Command
command: minecraft-pi-reborn-client

# Permissions
finish-args:
  - --persist=.minecraft-pi
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --share=network
  - --device=dri
  - --socket=pulseaudio
  - --allow=multiarch
  - --env=APPDIR=/app

# Desktop
rename-desktop-file: com.thebrokenrail.MCPIRebornClient.desktop
rename-icon: com.thebrokenrail.MCPIRebornClient
rename-appdata-file: com.thebrokenrail.MCPIRebornClient.appdata.xml

# MCPI-Reborn Git
x-mcpi-reborn-git: &mcpi-reborn-git
  type: git
  url: https://gitea.thebrokenrail.com/TheBrokenRail/minecraft-pi-reborn.git
  tag: 2.3.6
  disable-shallow-clone: true

# Build
modules:
  # patchelf
  - name: patchelf
    sources:
      - type: git
        url: https://github.com/NixOS/patchelf.git
        tag: 0.14.3
  # MCPI-Reborn Code
  - name: minecraft-pi-reborn
    buildsystem: cmake
    config-opts:
      - -DMCPI_BUILD_MODE=both
      - -DMCPI_OPEN_SOURCE_ONLY=ON
      - -DMCPI_IS_APPIMAGE_BUILD=ON
    sources:
      - *mcpi-reborn-git
      - type: patch
        path: glfw-wayland-build-fix.patch
        options:
          - --directory=dependencies/glfw/src
    # Nested Build
    modules:
      # FreeImage
      - name: freeimage
        no-autogen: true
        build-options:
          # C++17 Isn't Supported
          cxxflags: -std=c++14
        make-args:
          - DESTDIR=/app
        sources:
          - type: archive
            url: http://downloads.sourceforge.net/freeimage/FreeImage3180.zip
            sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
          - type: shell
            commands:
              - sed -i 's|-o root -g root ||' ./Makefile.gnu
              - sed -i 's|/usr|/app|' ./Makefile.gnu
  # Workaround https://github.com/hughsie/appstream-glib/issues/271
  - name: workaround-appstream-issue
    buildsystem: simple
    build-commands:
      - mkdir -p /app/usr/share/icons/hicolor/scalable/apps
      - ln -s ../../../../../../share/icons/hicolor/scalable/apps/com.thebrokenrail.MCPIReborn.png /app/usr/share/icons/hicolor/scalable/apps/com.thebrokenrail.MCPIReborn.png
  # Fix AppStream ID
  - name: fix-appstream-id
    buildsystem: simple
    build-commands:
      - sed -i 's/MCPIRebornClient/MCPIReborn/g' /app/share/metainfo/com.thebrokenrail.MCPIRebornClient.appdata.xml
      - sed -i 's/<\/component>/<releases><release version="Release" date="2000-01-01"><\/release><\/releases><\/component>/g' /app/share/metainfo/com.thebrokenrail.MCPIRebornClient.appdata.xml
    ensure-writable:
      - /share/metainfo/com.thebrokenrail.MCPIRebornClient.appdata.xml
  # Download MCPI Separately At Installation-Time
  - name: mcpi
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra /app/bin/apply_extra
      # Allow Starting MCPI
      - ln -s ../../extra/minecraft-pi /app/lib/minecraft-pi-reborn-client/minecraft-pi
    sources:
      - type: extra-data
        filename: mcpi.tar.gz
        url: https://s3.amazonaws.com/assets.minecraft.net/pi/minecraft-pi-0.1.1.tar.gz
        sha256: e0d68918874cdd403de1fd399380ae2930913fcefdbf60a3fbfebb62e2cfacab
        size: 1459472
      - type: script
        dest-filename: apply_extra
        commands:
          - tar -xf mcpi.tar.gz --strip-components 1
          - rm -f mcpi.tar.gz

# Cleanup
cleanup:
  - /include
  - /lib/pkgconfig
