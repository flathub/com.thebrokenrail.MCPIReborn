app-id: com.thebrokenrail.MCPIReborn

# No Separate Locales
separate-locales: false

# MCPI Itself Is Proprietary
tags:
  - proprietary

# Runtime/SDK
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node18

# Startup Command
command: minecraft-pi-reborn-client

# Permissions
finish-args:
  - --persist=.minecraft-pi
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --share=network
  - --device=dri
  - --socket=pulseaudio
  - --allow=multiarch

# MCPI-Reborn Git
x-mcpi-reborn-git: &mcpi-reborn-git
    type: git
    url: https://gitea.thebrokenrail.com/minecraft-pi-reborn/minecraft-pi-reborn.git
    commit: 69a9613e4f0b27bf7091cf520c7b98e2cae29d63
    disable-shallow-clone: true

# Build
modules:
  # MCPI-Reborn
  - name: minecraft-pi-reborn
    buildsystem: simple
    build-commands:
      - ./scripts/build.mjs flatpak client host --install -DMCPI_OPEN_SOURCE_ONLY=ON -DMCPI_APP_ID=com.thebrokenrail.MCPIReborn
    build-options:
        append-path: /usr/lib/sdk/node18/bin
        env:
            # The Runtime Automatically Includes An x86_64-Only Flag, So Reset Flags
            CFLAGS: ''
            CXXFLAGS: ''
            # Node.js Packages
            npm_config_cache: /run/build/minecraft-pi-reborn/flatpak-node/npm-cache
    sources:
      - *mcpi-reborn-git
      # Node.js Dependencies (Generated With flatpak-node-generator)
      - generated-sources.json
  # Download MCPI Separately At Installation-Time
  - name: minecraft-pi
    buildsystem: simple
    build-commands:
      - install -Dm755 apply_extra /app/bin/apply_extra
      # Allow Starting MCPI
      - ln -s ../../extra/minecraft-pi /app/lib/minecraft-pi-reborn-client/minecraft-pi
    sources:
      - type: extra-data
        filename: mcpi.tar.gz
        url: https://archive.org/download/MinecraftPi/minecraft-pi-0.1.1.tar.gz
        sha256: e0d68918874cdd403de1fd399380ae2930913fcefdbf60a3fbfebb62e2cfacab
        size: 1459472
      - type: script
        dest-filename: apply_extra
        commands:
          - tar -xf mcpi.tar.gz --strip-components 1
          - rm -f mcpi.tar.gz

# Cleanup
cleanup:
  - /include
  - /lib/pkgconfig
  - '*.a'
